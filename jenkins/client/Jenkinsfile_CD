@Library("jenkins-library") _

pipeline {
    agent any
    // *** Documentation ***
    // name: reactivities-client-app-cd
    // descrition: 'Continuous Delivery for the Reactivities client application.'
    // discardOldBuilds: strategy: Log Rotation, maxBuildsToKeep: 10
    // doNotAllowConcurrentBuilds: true
    // server env vars: ARTIFACTORY_CREDS_ID, ARTIFACTORY_CREDS_ID
    parameters {
        choice(
            name: 'DEPLOY_ENV',
            choices: ['dev','qa','prod'],
            description: 'Environment for which to deploy.',
        )
        choice(
            name: 'RUN_PACKAGE_DOWNLOAD',
            choices: ['Yes','No'],
            description: 'Whether to download the artifact(s).',
        )
        choice(
            name: 'RUN_PACKAGE_VERIFY',
            choices: ['Yes','No'],
            description: 'Whether to verify integrity of the artifact(s).',
        )
        string(
            name: 'CI_BUILD_NUMBER',
            description: 'Version of the package to deploy.  Same as the prefix + CI build number (e.g. "1.0.XXX").'
        )
    }
    environment {
        APP_NAME = 'reactivities'
        // TODO: consider removing from here -- making the reusable library self-aware of this 
        PACKAGES_PATH = '/packages'
        // TODO: ensure if prod is selected, use 'qa' instead -- add a way to translate between DEPLOY_ENV and actual BUILD_ENV
        PACKAGE_NAME = "reactivities-client-${DEPLOY_ENV}-${CI_BUILD_NUMBER}.tar.gz"
        PACKAGE_REPO_PATH = "reactivities/client/${DEPLOY_ENV}/${PACKAGE_NAME}"
    }
    stages {
        stage('Download Artifact') {
            when {
                expression { RUN_PACKAGE_DOWNLOAD == 'Yes' && CI_BUILD_NUMBER != '' }
            }
            agent {
                docker {
                    image 'node:16-alpine'
                }
            }
            steps {
                // sh "mkdir -p ${PACKAGES_PATH}"
                downloadArtifact([
                    ARTIFACTORY_CREDS_ID: "${ARTIFACTORY_CREDS_ID}",
                    ARTIFACTORY_SERVER: "${ARTIFACTORY_SERVER}",
                    PACKAGES_PATH: "${PACKAGES_PATH}",
                    PACKAGE_REPO_PATH: "${PACKAGE_REPO_PATH}",
                    PACKAGE_NAME: "${PACKAGE_NAME}"
                ])
            }
        }
        stage('Verify Artifact') {
            when {
                expression { RUN_PACKAGE_DOWNLOAD == 'Yes' && CI_BUILD_NUMBER != '' && RUN_PACKAGE_VERIFY == 'Yes'}
            }
            agent {
                docker {
                    image 'node:16-alpine'
                }
            }
            steps {
                // sh "mkdir -p ${PACKAGES_PATH}"
                verifyArtifact([
                    ARTIFACTORY_CREDS_ID: "${ARTIFACTORY_CREDS_ID}",
                    ARTIFACTORY_SERVER: "${ARTIFACTORY_SERVER}",
                    PACKAGES_PATH: "${PACKAGES_PATH}",
                    PACKAGE_REPO_PATH: "${PACKAGE_REPO_PATH}",
                    PACKAGE_NAME: "${PACKAGE_NAME}"
                ])
            }
        }
    }
}